# Nginx HTTPS configuration for ecomarce_choco
# For use with self-signed certificate (IP address) or Let's Encrypt (domain)
# 
# IMPORTANT: Replace these values:
# - yourdomain.com → Your actual domain (or use IP: 164.90.215.173)
# - your-droplet-ip → Your Droplet IP address
#
# For self-signed certificate:
# 1. Generate certificate: sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#    -keyout /etc/nginx/ssl/selfsigned.key -out /etc/nginx/ssl/selfsigned.crt \
#    -subj "/C=AE/ST=Dubai/L=Dubai/O=ChocoEcommerce/CN=your-droplet-ip"
# 2. Update ssl_certificate paths below to use /etc/nginx/ssl/selfsigned.crt
#
# For Let's Encrypt (domain):
# 1. Run: sudo certbot --nginx -d yourdomain.com
# 2. Certbot will automatically update this config with proper paths

upstream django {
    server 127.0.0.1:8000;
}

# HTTP Server - Redirect to HTTPS
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com your-droplet-ip;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS Server
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com your-droplet-ip;

    # SSL Certificate (Self-Signed - for IP address)
    # Uncomment these lines for self-signed certificate:
    # ssl_certificate /etc/nginx/ssl/selfsigned.crt;
    # ssl_certificate_key /etc/nginx/ssl/selfsigned.key;

    # SSL Certificate (Let's Encrypt - for domain)
    # Uncomment these lines after running certbot:
    # ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    client_max_body_size 10M;  # Allow file uploads up to 10MB

    # Static files
    location /static/ {
        alias /home/django/ecomarce_choco/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Media files
    location /media/ {
        alias /home/django/ecomarce_choco/media/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # GraphQL API
    location /graphql/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Django Admin
    location /admin/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default - proxy to Django
    location / {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}

